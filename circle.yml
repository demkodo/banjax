dependencies:
  override:
    - sudo add-apt-repository --yes ppa:ubuntu-toolchain-r/test
    - sudo apt-get update
    - sudo apt-get install g++-5 tcl-dev libyaml-cpp-dev libzmq-dev libboost-dev libconfig++-dev libssl-dev libboost-system-dev libboost-test-dev
    - sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 1
    - ls; pwd; nproc
    - cd ..; git clone git@github.com:google/re2.git && cd re2; make && sudo make install
    - sudo cp ~/re2/obj/so/lib* /lib/
    - cd ..; wget http://tux.rainside.sk/apache/trafficserver/trafficserver-7.0.0.tar.bz2
    - cd ..; tar xf trafficserver-7.0.0.tar.bz2
    - cd ../trafficserver-7.0.0 && ./configure --prefix=`pwd`/../ts && make -j`nproc` && make install
    - find ../ts
    - echo "banjax/banjax.so $HOME/ts/libexec/trafficserver/banjax/" >> ../ts/etc/trafficserver/plugin.config
    - echo "regex_map http://^127.0.0.1:8080$/ http://127.0.0.1:8000/" >> ../ts/etc/trafficserver/remap.config
    - perl -pi -e 's/CONFIG proxy.config.http.cache.required_headers INT .+/CONFIG proxy.config.http.cache.required_headers INT 0/g' ../ts/etc/trafficserver/records.config
    - cat ../ts/etc/trafficserver/records.config
    - mkdir build
    - cd build && cmake ../ -DCMAKE_CXX_FLAGS="-I$HOME/ts/include"
    - cd build && make -j`nproc`
    - mkdir -p ../http
    - mkdir ../ts/libexec/trafficserver/banjax
    - cp config/{auth,solver}.html ../ts/libexec/trafficserver/banjax/
    - cp build/banjax.so ../ts/libexec/trafficserver/banjax/
test:
  override:
    - ./build/unit-tests
    - python ./test/banjax_behavior_test.py --ts-prefix=`pwd`/../ts --ts-layout="standard"
